# Defora ‚Äî audio-visual instrument for Stable Diffusion Forge/Deforumation

<p align="center">
  <img src="assets/defora_logo.svg" alt="defora logo" width="480" />
</p>

Defora turns Stable Diffusion Forge + Deforumation into a playable instrument: live visuals, prompt morphing, camera motion, beat-synced controls, and a neon-styled web UI for performance.

## ‚ú® Feature Highlights

### üéπ Live Performance Interface
Control your AI video generation in real-time with multiple interface options:

<table>
<tr>
<td width="50%">
<h4>Web UI ‚Äî Browser-based Performance Dashboard</h4>
<img src="screenshots/live-tab.png" alt="Web UI Live Tab" width="100%" />
<p>Neon-styled web interface with macro sliders, motion presets, and live parameter control</p>
</td>
<td width="50%">
<h4>TUI ‚Äî Terminal-based Control Center</h4>
<img src="screenshots/tui-live.png" alt="TUI Live Tab" width="100%" />
<p>Full-featured ncurses interface for terminal enthusiasts with ASCII preview and parameter control</p>
</td>
</tr>
</table>

### üé® Advanced Prompt Management
Morph between multiple prompts and control narrative flow:

<table>
<tr>
<td width="50%">
<img src="screenshots/prompts-tab.png" alt="Web UI Prompts" width="100%" />
<p><b>Web UI:</b> Visual prompt morphing with slots and blend control</p>
</td>
<td width="50%">
<img src="screenshots/tui-prompts.png" alt="TUI Prompts" width="100%" />
<p><b>TUI:</b> Text-based prompt management with morph ranges</p>
</td>
</tr>
</table>

### üé• Camera Motion Control
Gamepad-style camera controls and curve editing:

<table>
<tr>
<td width="50%">
<img src="screenshots/motion-tab.png" alt="Web UI Motion" width="100%" />
<p><b>Web UI:</b> Visual motion curves with preset system</p>
</td>
<td width="50%">
<img src="screenshots/tui-motion.png" alt="TUI Motion" width="100%" />
<p><b>TUI:</b> Multi-lane curve editor in your terminal</p>
</td>
</tr>
</table>

### üéµ Audio-Reactive Modulation
Sync your visuals to audio with beat-driven macros:

<table>
<tr>
<td width="50%">
<img src="screenshots/audio-tab.png" alt="Web UI Audio" width="100%" />
<p><b>Web UI:</b> Waveform visualization with macro rack</p>
</td>
<td width="50%">
<img src="screenshots/tui-audio.png" alt="TUI Audio" width="100%" />
<p><b>TUI:</b> Beat-synced parameter automation</p>
</td>
</tr>
</table>

### üéõÔ∏è ControlNet Integration & Settings
Fine-tune your generation with ControlNet and render settings:

<table>
<tr>
<td width="50%">
<img src="screenshots/cn-tab.png" alt="Web UI ControlNet" width="100%" />
<img src="screenshots/settings-tab.png" alt="Web UI Settings" width="100%" />
<p><b>Web UI:</b> ControlNet slots and engine configuration</p>
</td>
<td width="50%">
<img src="screenshots/tui-controlnet.png" alt="TUI ControlNet" width="100%" />
<img src="screenshots/tui-settings.png" alt="TUI Settings" width="100%" />
<p><b>TUI:</b> Complete control from your terminal</p>
</td>
</tr>
</table>

### üéº MIDI Controller Support
Map any MIDI controller to live parameters:
- **Web UI**: Browser-based Web MIDI support
- **TUI**: CC mapping with learn mode
- Full parameter control via hardware knobs and faders

## Requires
- Moderately fast GPU (4070ti / 5060ti tested) with at least 12G VRAM
- Models that have either Lightning support or accompanying LORa that need 1-2 steps for a frame. SDXL Lightning is proven to be working fine
- 32GB ram is minimum, 64gb ram recommended
- Stable Diffusion Forge + Deforum extension from **https://github.com/Tok/sd-forge-deforum** and **https://github.com/lllyasviel/stable-diffusion-webui-forge**
- There is docker stack including these in the package but it is recommended to run on external node 

## What‚Äôs inside
- `forge_cli` ‚Äî model-aware txt2img/Deforum CLI with preset support and sensible defaults.
- `deforumation_request_dispatcher` ‚Äî merges manifests/presets/overrides and runs `forge_cli` for rerun/continue flows.
- `deforumation_runs_cli` ‚Äî curses TUI to browse run manifests, set overrides, and emit rerun/continue request files (can auto-dispatch).
- `deforumation_cli_panel` ‚Äî live mediator control panel (strength/CFG/noise/pan/zoom/rot/FOV) with re-bindable hotkeys.
- `deforumation_dashboard` ‚Äî curses dashboard echoing the Deforumation GUI tabs (prompts, prompt mixer, motions, control toggles, audio sync, settings) using the upstream config JSON. Presets: load with `--preset <name>` (from `deforumation/presets/<name>.json`) and save with `--save-preset <name>`.
- `audio_reactive_modulator` ‚Äî map audio bands to mediator parameters; output a schedule or stream live.
- `monitor_cli` ‚Äî tail the latest frames and show live mediator values.
- `stream_helper` ‚Äî push rendered frames to RTMP/SRT/WHIP via ffmpeg.
- `docker-compose` stack ‚Äî ffmpeg encoder + Nginx/Node (HLS + authable controls) + RabbitMQ + mediator control bridge to view frames as live video in a browser.
- Docs and schema helpers under `docs/` (run manifest schema, workflows, server targeting, panel notes).

## üöÄ Quick Start

### 1. Clone and Install
```bash
git clone https://github.com/janiluuk/defora.git
cd defora
git submodule update --init --recursive
# or: ./scripts/clone_deforumation.sh
pip install -r requirements.txt
```

### 2. Start Stable Diffusion Forge
Start Forge with Deforum API enabled:
```bash
# Example: assuming Forge is installed in ~/stable-diffusion-webui-forge
cd ~/stable-diffusion-webui-forge
./webui.sh --deforum-api
```

### 3. Choose Your Interface

#### üéπ Quick Generation (Command Line)
Generate images or animations with smart defaults:
```bash
# Single image
./forge_cli "a synthwave city at night"

# Animation (240 frames)
./forge_cli deforum -f 240 "surreal biomechanical cathedral"
```

#### üéÆ Live Performance (Web UI)
Full browser-based performance interface:
```bash
docker-compose up --build
# Open http://localhost:8080
```
**Features**: Live macro sliders, prompt morphing, motion curves, audio sync, MIDI control

#### üíª Terminal Control (TUI)
Full-featured ncurses interface for terminal users:
```bash
./defora_tui
```
**Navigation**: F1-F6 to switch tabs, ‚Üê/‚Üí to adjust parameters, Q to quit

#### üéõÔ∏è Lightweight Panel (CLI)
Minimal control panel with hotkey bindings:
```bash
./deforumation_cli_panel --host 127.0.0.1 --port 8766
```

### 4. Advanced Tools

**Browse & Rerun Saved Generations:**
```bash
./deforumation_runs_cli
```

**Audio-Reactive Modulation:**
```bash
# Generate audio schedule
./audio_reactive_modulator --audio song.wav --fps 24 --output audio_mod.json

# Stream live to mediator
./audio_reactive_modulator --audio song.wav --fps 24 --live \
  --mediator-host 127.0.0.1 --mediator-port 8766
```

**Monitor Live Generation:**
```bash
./monitor_cli --frames runs/<id>/frames
```

**Stream to RTMP/SRT:**
```bash
./stream_helper start --source runs/<id>/frames \
  --target rtmp://example/live/key --fps 24
```

## Key concepts
- **Audio-visual instrument**: Treat prompts, camera, and ControlNet as live parameters; drive them via CLI/TUI/Web or controllers.
- **Presets & manifests**: Deforum JSON presets and run manifests can be merged with CLI overrides. The runs TUI writes `*_request.json` that the dispatcher consumes.
- **Mediator control**: The panel, dashboard, and audio modulator talk to the mediator websocket so you can steer generation without the full UI.
- **Model-aware defaults**: `forge_cli` picks steps/CFG/sampler based on the active model (Flux/SDXL/SD1.5) and can auto-switch to Flux-schnell.

## Mediator (DeforumationQT)
- The DeforumationQT mediator is vendored under `deforumation/`. Run it to bridge SD-Forge/Deforum to the Deforumation UI and our CLI tools (panel/dashboard/audio modulator).
- See `docs/mediator_setup.md` for mediator startup steps and for installing the sd-forge Deforum bridge from `deforumation/Deforum_Version/sd-forge/`.
- Docker users: `docker-compose up --build mediator sd-forge` will start the mediator (ports 8765/8766) and a Forge container with the Deforumation-patched Deforum extension pre-installed (UI on port 7860).

## Environment knobs
- `FORGE_API_BASE` ‚Äî target Forge server (e.g., `http://192.168.2.101:7860`).
- `FORGE_OUT_DIR` ‚Äî output directory for `forge_cli`.
- `DEFORUMATION_FORGE_CLI` ‚Äî path override for Forge CLI when auto-dispatching.
- `DEFORUMATION_AUTO_DISPATCH=1` ‚Äî have `deforumation_runs_cli` immediately dispatch requests.
- `DEFORUMATION_FRAMES_DIR` ‚Äî default frames path for `monitor_cli`.
- `DEFORUMATION_ASCII_PREVIEW=1` ‚Äî enable ASCII thumbnails in monitor/runs TUI (needs Pillow).
- `DEFORUMATION_MEDIATOR_HOST`/`DEFORUMATION_MEDIATOR_PORT` ‚Äî defaults for mediator-backed UIs (panel, dashboard, monitor).
- `CONTROL_TOKEN` ‚Äî WebSocket control token for the web UI (set when running docker-compose).
- `MEDIATOR_HOST` (compose bridge) ‚Äî set this if `host.docker.internal` is not available on your host (common on Linux) so the control bridge can reach the mediator.
- Web MIDI: enable in your browser and map controls in the web UI (MIDI tab) to live parameters.

## Layout
- CLI/package code: `defora_cli/`
- Executable wrappers: `./forge_cli`, `./deforumation_request_dispatcher`, `./deforumation_runs_cli`, `./deforumation_cli_panel`, `./deforumation_dashboard`, `./defora_tui`, `./monitor_cli`, `./stream_helper`, `./audio_reactive_modulator`
- Web UI & streaming stack: `docker-compose.yml`, `docker/web/` (Nginx+Node+Vue front-end, HLS, controls), `docker/bridge/` (mediator bridge)
- Docs: `docs/` (workflows, server targeting, schema, streaming)
- Tests: `tests/` (Python) and `docker/web/test` (web UI smoke tests)
- Logo: `assets/defora_logo.svg` (dark-mode friendly, neon gradient)

## Testing
Run the suite (requires pytest installed):
```bash
./scripts/run_tests.sh  # or: python -m pytest
```
