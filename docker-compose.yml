services:
  encoder:
    image: jrottenberg/ffmpeg:4.4-alpine
    command: >
      sh -c "
        until ls /data/frames/frame_00001.png >/dev/null 2>&1; do
          echo 'Waiting for frames in /data/frames ...';
          sleep 2;
        done;
        ffmpeg -re -framerate ${FPS:-24} -pattern_type glob -i '/data/frames/frame_*.png'
          -vf scale=${RESOLUTION:-1280:720}
          -c:v libx264 -preset veryfast -tune zerolatency -g $(( ${FPS:-24} * 2 ))
          -f flv rtmp://web:1935/live/deforum
      "
    volumes:
      - frames:/data/frames
    depends_on:
      - web

  web:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    ports:
      - "8080:80"
      - "1935:1935"
    volumes:
      - frames:/data/frames:ro
      - hls:/var/www/hls
    environment:
      - RABBIT_URL=amqp://mq
      - FRAMES_DIR=/data/frames
      - HLS_STREAM=/hls/live/deforum.m3u8
      - HLS_DIR=/var/www/hls
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health" , "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  mediator:
    build:
      context: .
      dockerfile: docker/mediator/Dockerfile
    ports:
      - "8765:8765"
      - "8766:8766"
    environment:
      - MEDIATOR_DEFORUM_ADDRESS=0.0.0.0
      - MEDIATOR_DEFORUM_PORT=8765
      - MEDIATOR_DEFORUMATION_ADDRESS=0.0.0.0
      - MEDIATOR_DEFORUMATION_PORT=8766
      - DEFORUMATION_ADDRESS=${DEFORUMATION_ADDRESS:-127.0.0.1}
      - DEFORUMATION_PORT=${DEFORUMATION_PORT:-8767}
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8765 && nc -z localhost 8766 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  sd-forge:
    build:
      context: .
      dockerfile: docker/sd-forge/Dockerfile
      args:
        DEFORUM_MEDIATOR_URL: ${DEFORUM_MEDIATOR_URL:-ws://mediator:8765}
    image: sd-forge:latest
    command: 
      - python
      - launch.py
      - --listen
      - --port
      - "7860"
      - --deforum-api
      - --enable-insecure-extension-access
      - --skip-version-check
      - --no-half-vae
      - --xformers
    ports:
      - "7860:7860"
    volumes:
      - frames:/data/frames
      - hls:/var/www/hls
      - models:/stable-diffusion-webui/models
      - outputs:/stable-diffusion-webui/outputs
    environment:
      - OUTPUT_DIR=/data/frames
      - HLS_PATH=/var/www/hls
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:7860/docs\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    depends_on:
      web:
        condition: service_healthy
      mediator:
        condition: service_healthy

  dev-frame-seeder:
    build:
      context: .
      dockerfile: docker/frame-seeder/Dockerfile
    environment:
      - OUTPUT_DIR=/data/frames
      - FPS=12
      - CLEAR=1
    volumes:
      - frames:/data/frames
    depends_on:
      - web

  mq:
    image: rabbitmq:3-management
    ports:
      - "15672:15672"
      - "5672:5672"
    volumes:
      - mqdata:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  control-bridge:
    build:
      context: .
      dockerfile: docker/bridge/Dockerfile
    environment:
      - MQ_URL=amqp://mq
      - MQ_QUEUE=controls
      - MEDIATOR_HOST=${MEDIATOR_HOST:-mediator}
      - MEDIATOR_PORT=${MEDIATOR_PORT:-8766}
    depends_on:
      mq:
        condition: service_healthy
      mediator:
        condition: service_healthy

volumes:
  frames:
  hls:
  mqdata:
  models:
  outputs:
